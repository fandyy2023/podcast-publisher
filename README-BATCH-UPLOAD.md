# Пакетная загрузка эпизодов подкастов

Эта документация описывает функционал пакетной загрузки эпизодов в Podcast Publisher, который позволяет создавать несколько эпизодов одновременно на основе метаданных из Excel-файлов.

## Оглавление

1. [Обзор функционала](#обзор-функционала)
2. [Структура Excel-файлов](#структура-excel-файлов)
3. [Интерфейс пользователя](#интерфейс-пользователя)
4. [API-эндпоинты](#api-эндпоинты)
5. [Техническая реализация](#техническая-реализация)
6. [Ограничения и дальнейшее развитие](#ограничения-и-дальнейшее-развитие)

## Обзор функционала

Пакетная загрузка позволяет:
- Загрузить метаданные эпизодов из Excel-файлов
- Сопоставить аудиофайлы и изображения с данными из Excel по номеру эпизода
- Отобразить жанры в виде лейблов с возможностью удаления
- Выбрать шоу для каждого эпизода из существующих или создать новое
- Поддерживать разные языковые версии (разные Excel-файлы для разных языков)
- Создавать несколько эпизодов одновременно

## Структура Excel-файлов

Система поддерживает Excel-файлы с разными именами столбцов для разных языков. Файлы должны находиться в корне проекта или в папке `/data` и иметь имя, соответствующее языку (например, `english.xlsx`, `russian.xlsx`).

### Поддерживаемые столбцы для английского языка:
- `Number` или `Episode` - номер эпизода (обязательно)
- `Title` - название эпизода (обязательно)
- `Summary` или `Description` - краткое описание
- `About` или `Full description` - полное описание
- `Genre` или `Genres` - жанры, разделенные запятыми

### Поддерживаемые столбцы для русского языка:
- `Номер` - номер эпизода (обязательно)
- `Название` - название эпизода (обязательно)
- `Описание` - краткое описание
- `Полное описание` - полное описание
- `Жанр` или `Жанры` - жанры, разделенные запятыми

Пример английского Excel-файла:

| Number | Title | Summary | Full description | Genre |
|--------|-------|---------|-----------------|-------|
| 1 | Introduction to Podcasting | Learn the basics | In this episode... | Education,Technology |
| 2 | Equipment for Beginners | Essential gear | We discuss... | Technology,Equipment |

## Интерфейс пользователя

Интерфейс пакетной загрузки доступен на странице настроек, вкладка "Пакетная загрузка". Процесс загрузки состоит из следующих шагов:

1. Выбор языка из выпадающего списка
2. Загрузка аудиофайлов и изображений путем перетаскивания в область загрузки
3. Просмотр сопоставленных метаданных и файлов в таблице
4. Выбор шоу для каждого эпизода
5. Редактирование жанров (добавление/удаление тегов)
6. Выбор эпизодов для загрузки через чекбоксы
7. Нажатие кнопки "Загрузить выбранные эпизоды"

## API-эндпоинты

### Получение метаданных из Excel-файла

```
GET /api/batch_upload/metadata?language={language}
```

Параметры:
- `language` - язык (например, "english", "russian")

Ответ:
```json
[
  {
    "number": 1,
    "title": "Introduction to Podcasting",
    "description": "Learn the basics of podcasting",
    "about": "In this episode...",
    "genre": "Education,Technology"
  },
  // ...
]
```

### Получение списка шоу

```
GET /api/shows
```

Ответ:
```json
[
  {
    "id": "podcast-1",
    "title": "My Podcast",
    "image": "cover.jpg",
    "genres": ["Technology", "Education"]
  },
  // ...
]
```

### Создание эпизодов

```
POST /api/batch_upload/episodes
```

Тело запроса:
```json
{
  "episodes": [
    {
      "number": 1,
      "title": "Introduction to Podcasting",
      "summary": "Learn the basics",
      "description": "In this episode...",
      "genres": ["Education", "Technology"],
      "showId": "podcast-1"
    },
    // ...
  ],
  "language": "english"
}
```

Ответ:
```json
{
  "created": 2,
  "failed": 0,
  "errors": []
}
```

## Техническая реализация

Функционал пакетной загрузки реализован с использованием следующих компонентов:

1. **Backend (Python/Flask)**:
   - Модуль `batch_upload.py` - содержит основные функции и API-эндпоинты
   - Модуль `episode.py` - функции для создания эпизодов
   - Модуль `utils.py` - содержит функцию `resize_cover_image` для обработки обложек

2. **Frontend (JavaScript)**:
   - Интерфейс на странице настроек (`settings.html`)
   - Drag-and-drop загрузка файлов
   - Динамическое формирование таблицы сопоставления
   - Асинхронное взаимодействие с API

3. **Интеграция**:
   - Инициализация API-маршрутов в `app.py`
   - Поддержка разных языков через Excel-файлы

### Обработка изображений

При пакетной загрузке изображения обрабатываются с использованием функции `resize_cover_image` из модуля `utils.py`. Эта функция выполняет следующие операции:

1. **Преобразование в квадратное изображение** - если изображение не квадратное, более короткая сторона дополняется фоновым цветом.
   
2. **Изменение размера** - изображение изменяется до размера между 1400 и 3000 пикселей (min_size и max_size):
   - Если изображение больше max_size, оно уменьшается
   - Если меньше min_size, оно увеличивается

3. **Сохранение формата** - формат файла сохраняется:
   - Если загружен PNG, он остается PNG
   - Для всех остальных форматов (JPG, JPEG и др.) используется JPEG с высоким качеством

### Чанковая загрузка

Пакетная загрузка автоматически использует настройку "Чанковая загрузка по умолчанию", которая доступна на странице настроек:

- Если опция включена, файлы >100MB загружаются по частям (чанкам)
- Если опция выключена, все файлы загружаются стандартным способом

Эта настройка позволяет обходить ограничения Cloudflare на размер загружаемых файлов в 100MB.

## Сетевая инфраструктура и туннели

### Почему нужны туннели и поддомены
Cloudflare ограничивает загрузку файлов размером более **100 МБ** на бесплатном и PRO-тарифах. Чтобы обходить это ограничение, реализованы два параллельных подхода:

1. **Поддомен `upload.example.com` (DNS-Only / «серый облачко»)**  
   • Записи типа *A* или *CNAME* указывают прямо на ваш сервер.  
   • Cloudflare не проксирует такие запросы, поэтому лимит 100 МБ отсутствует.  
   • Используется для обычных (нечанковых) загрузок крупных файлов, когда у сервера есть белый IP.

2. **Чанковая загрузка через основной домен (прокси Cloudflare)**  
   • Большие файлы разбиваются фронтендом на чанки по 8–10 МБ.  
   • Каждый чанк проходит через Cloudflare без превышения лимита.  
   • Работает даже при использовании Cloudflare Tunnel (Argo) или при отсутствии публичного IP.

### Поток данных при пакетной загрузке

```mermaid
sequenceDiagram
  participant User as Browser
  participant Flask as Flask API (5050)
  participant S3 as Local Storage

  User->>Flask: GET /api/batch_upload/metadata?language=en
  Flask-->>User: JSON метаданных

  User->>Flask: POST /api/batch_upload/episodes (метаданные, без файлов)
  Flask-->>User: {"created": N, "failed": 0}

  Note over User,Flask: (будущая версия)
  User->>Flask: POST /api/upload/chunk (audio/image)
  Flask->>S3: Запись временного чанка
  loop until last chunk
  end
  User->>Flask: POST /api/upload/complete
  Flask->>S3: Сборка финального файла
  Flask-->>User: 201 Created
```

### Реализованные эндпоинты
| Маршрут | Метод | Статус | Описание |
|---------|-------|--------|----------|
| `/api/batch_upload/metadata` | GET | ✅ | Чтение Excel-файла, парсинг метаданных |
| `/api/batch_upload/episodes` | POST | ✅ | Массовое создание эпизодов **без** файлов |
| `/api/upload/chunk` | POST | 🔜 | Приём фрагмента файла |
| `/api/upload/complete` | POST | 🔜 | Сборка чанков в итоговый файл |
| `/api/upload/status` | GET | 🔜 | Проверка состояния загрузки |
| `/api/upload/cleanup` | POST | 🔜 | Очистка старых чанков |

> 🔜 — планируется, но ещё не завершено.

### Что уже работает
* Excel-файлы читаются для **English** и **Russian** таблиц.  
* Файлы аудио/обложек сопоставляются с метаданными по номеру.  
* UI позволяет выбрать шоу, отредактировать жанры, снять/поставить чекбоксы.  
* После нажатия «Загрузить выбранные эпизоды» создаются записи эпизодов, а UI показывает результат.

### Что осталось сделать
* Реализовать загрузку аудио/обложек (чанковая и обычная).  
* Автоматическое создание нового шоу из UI.  
* Отчистка временных чанков и валидация контрольных сумм.

---

## Ограничения и дальнейшее развитие

### Текущие ограничения:

- Загрузка аудиофайлов и изображений пока не реализована (только создание метаданных)
- Создание нового шоу из интерфейса пакетной загрузки пока не реализовано
- Поддерживаются только основные форматы метаданных

### Планы по развитию:

1. **Добавление загрузки файлов**:
   - Реализация API для загрузки аудиофайлов и изображений
   - Поддержка чанкового режима для больших файлов

2. **Создание новых шоу**:
   - Интерфейс для создания нового шоу в процессе пакетной загрузки
   - Автоматическое использование жанров из эпизодов

3. **Расширенные функции**:
   - Предпросмотр метаданных перед загрузкой
   - Массовое редактирование метаданных
   - Интеграция с внешними источниками метаданных

---

Разработано для Podcast Publisher, 2025
