# Чанковая загрузка больших файлов

## Проблема
Cloudflare ограничивает размер одного HTTP-запроса до 100 МБ. При загрузке аудиофайлов для подкаста это ограничение может стать проблемой, так как эпизоды часто превышают этот размер.

## Решение
Реализована система чанковой (фрагментированной) загрузки файлов:

1. **Принцип работы:**
   - Большие файлы разбиваются на маленькие фрагменты (до 10 МБ каждый)
   - Каждый фрагмент отправляется отдельным HTTP-запросом
   - Сервер собирает фрагменты в единый файл
   - Не требует Caddy, прямого доступа к портам или белого IP

2. **Компоненты решения:**
   - Backend API для приема, хранения и сборки фрагментов
   - Frontend JavaScript для разбиения файлов и отслеживания процесса загрузки
   - Интеграция с существующей системой создания эпизодов

## Как это работает

### Backend
Добавлены новые API-эндпоинты:

- `POST /api/upload/chunk`: Принимает один фрагмент файла
- `POST /api/upload/complete`: Объединяет фрагменты в итоговый файл
- `GET /api/upload/status`: Проверяет статус загрузки
- `POST /api/upload/cleanup`: Очищает старые/незавершенные загрузки

Временные файлы хранятся в директории `tmp_uploads`.

### Frontend
JavaScript-библиотека `chunked-uploader.js`:
- Автоматически разбивает большие файлы на части
- Показывает прогресс загрузки
- Поддерживает повторные попытки при сбоях
- Интегрируется с формой создания эпизода

## Страница настроек

### Реализация настроек

1. **Доступ к настройкам**:
   - На главной странице со списком подкастов добавлена иконка ⚙️
   - При нажатии пользователь переходит на страницу `/settings`

2. **Параметры настроек**:
   - `chunked_upload_default`: включение/выключение чанковой загрузки по умолчанию

3. **Хранение настроек**:
   - Настройки хранятся в файле `settings.json` в корневой директории проекта
   - Формат: JSON-объект с ключами для каждого параметра

4. **Backend**:
   - Маршрут `/settings` (GET): отображает страницу настроек с текущими значениями
   - Маршрут `/settings` (POST): сохраняет измененные настройки в `settings.json`
   - API-эндпоинт `/api/settings` (GET): возвращает текущие настройки в формате JSON

5. **Frontend**:
   - Интерфейс с переключателями (toggle switches) для каждой опции
   - AJAX-запросы для сохранения настроек без перезагрузки страницы
   - Индикация успешного сохранения

### Логика выбора способа загрузки

1. **Обновленное поведение**:
   - Если настройка "чанковая загрузка" **включена**: дробятся ТОЛЬКО файлы >100MB
   - Если настройка "чанковая загрузка" **выключена**: не используется чанковая загрузка вообще (даже для больших файлов)

2. **Реализация в коде**:
   ```javascript
   // Определяем, нужно ли использовать чанковую загрузку:
   // 1. Если настройка включена - дробим только большие файлы (>100MB)
   // 2. Если настройка выключена - не используем чанковую загрузку вообще
   const shouldUseChunkedUpload = useChunkedUpload && fileSizeMB > 100;
   ```

## Использование

Поведение для пользователя определяется настройками:

1. **При выключенной опции "Чанковая загрузка по умолчанию"**:
   - Все файлы загружаются стандартным способом, независимо от размера
   - Пользователь может столкнуться с ограничениями Cloudflare при загрузке файлов >100MB

2. **При включенной опции "Чанковая загрузка по умолчанию"**:
   - Файлы до 100 МБ загружаются стандартным способом
   - Файлы более 100 МБ загружаются чанками автоматически:
     - Показывается индикатор прогресса
     - Кнопка "Создать эпизод" блокируется до завершения загрузки
     - После завершения загрузки форма отправляется как обычно

## Технические детали

- **Размер чанка:** 8-10 МБ (настраивается)
- **Идентификация загрузки:** Каждой загрузке присваивается уникальный ID
- **Параллелизм:** Одновременно может загружаться до 3-х чанков
- **Хранение:** Временные файлы удаляются через 24 часа

## Безопасность

- Применяется `secure_filename` для защиты от path traversal
- Используется проверка хэша файла для подтверждения целостности
- Временные файлы доступны только через API эндпоинты
